<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Happy Birthday</title>
<style>
    :root{
        --bg:#fff0f6;
        --accent:#ff4f7a;
        --paper:#fff8e6;
        --cake:#ffb86b;
        --choco:#7b3f00;
        --heart1:#ff6b81;
        --heart2:#ffd86b;
        --heart3:#ff9ac8;
        --heart4:#ffb3a7;
        --heart5:#ffc3e1;
    }

    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    body{
        display:flex;align-items:center;justify-content:center;
        background:
            radial-gradient(circle at 20% 30%, rgba(255,182,193,0.3) 0%, transparent 50%),
            radial-gradient(circle at 80% 70%, rgba(255,192,203,0.25) 0%, transparent 50%),
            radial-gradient(circle at 50% 50%, rgba(255,218,224,0.2) 0%, transparent 70%),
            linear-gradient(135deg, #ffe4e9 0%, #ffd4e5 25%, #ffe9f0 50%, #fff0f8 75%, #fff5fa 100%);
        padding:24px;
        overflow:hidden;
        position:relative;
    }

    /* 3D floating elements background */
    .floating-3d {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 0;
        overflow: hidden;
        perspective: 1000px;
    }

    .float-element {
        position: absolute;
        animation: float3d var(--duration, 20s) ease-in-out infinite;
        animation-delay: var(--delay, 0s);
        transform-style: preserve-3d;
    }

    /* 3D Hearts */
    .heart-3d {
        width: var(--size, 40px);
        height: var(--size, 40px);
        position: relative;
        transform-style: preserve-3d;
        filter: drop-shadow(0 8px 20px rgba(255, 107, 129, 0.2));
    }

    .heart-3d::before,
    .heart-3d::after {
        content: "";
        position: absolute;
        width: var(--size, 40px);
        height: calc(var(--size, 40px) * 1.5);
        background: linear-gradient(135deg, var(--color, #ff6b81), var(--color2, #ff9ac8));
        border-radius: calc(var(--size, 40px) / 2) calc(var(--size, 40px) / 2) 0 0;
        transform-origin: bottom center;
    }

    .heart-3d::before {
        left: calc(var(--size, 40px) / -2);
        transform: rotate(-45deg);
    }

    .heart-3d::after {
        left: calc(var(--size, 40px) / 2);
        transform: rotate(45deg);
    }

    /* 3D Stars */
    .star-3d {
        width: var(--size, 30px);
        height: var(--size, 30px);
        background: linear-gradient(45deg, #ffd700, #ffed4e);
        clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
        filter: drop-shadow(0 6px 15px rgba(255, 215, 0, 0.3));
    }

    /* 3D Diamonds */
    .diamond-3d {
        width: var(--size, 25px);
        height: var(--size, 25px);
        background: linear-gradient(135deg, #ffc3e1, #ffb3d9, #ffa8d3);
        clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%);
        filter: drop-shadow(0 6px 15px rgba(255, 195, 225, 0.3));
        transform-style: preserve-3d;
    }

    /* 3D Sparkles */
    .sparkle-3d {
        width: var(--size, 20px);
        height: var(--size, 20px);
        position: relative;
    }

    .sparkle-3d::before,
    .sparkle-3d::after {
        content: "";
        position: absolute;
        background: linear-gradient(90deg, transparent, #fff, transparent);
        animation: sparkle 2s ease-in-out infinite;
    }

    .sparkle-3d::before {
        width: 100%;
        height: 2px;
        top: 50%;
        left: 0;
        transform: translateY(-50%);
    }

    .sparkle-3d::after {
        width: 2px;
        height: 100%;
        left: 50%;
        top: 0;
        transform: translateX(-50%);
        animation-delay: 0.3s;
    }

    @keyframes float3d {
        0%, 100% {
            transform: translate3d(0, 0, 0) rotateX(0deg) rotateY(0deg) rotateZ(0deg);
        }
        25% {
            transform: translate3d(var(--tx1, 20px), var(--ty1, -30px), var(--tz1, 20px)) rotateX(15deg) rotateY(25deg) rotateZ(5deg);
        }
        50% {
            transform: translate3d(var(--tx2, -15px), var(--ty2, -60px), var(--tz2, -15px)) rotateX(-10deg) rotateY(-20deg) rotateZ(-8deg);
        }
        75% {
            transform: translate3d(var(--tx3, 25px), var(--ty3, -90px), var(--tz3, 25px)) rotateX(20deg) rotateY(15deg) rotateZ(10deg);
        }
    }

    @keyframes sparkle {
        0%, 100% { opacity: 0.3; }
        50% { opacity: 1; }
    }

    /* floating heart background */
    .bg-hearts{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden}
    .bg-hearts .heart{
        position:absolute;
        bottom:-80px;
        width:var(--size,28px);
        height:var(--size,28px);
        background:var(--color,#ff6b81);
        transform:rotate(45deg) translateY(0) scale(var(--scale,1));
        border-radius:6px 6px 0 0;
        opacity:0;
        filter:drop-shadow(0 6px 12px rgba(255,107,129,.15));
        animation: floatUp calc(var(--duration,10s)) linear infinite;
        animation-delay: calc(var(--delay,0s));
    }
    .bg-hearts .heart::before,
    .bg-hearts .heart::after{
        content:"";
        position:absolute;
        width:50%;
        height:50%;
        background:inherit;
        border-radius:50%;
    }
    .bg-hearts .heart::before{ top:-25%; left:0; }
    .bg-hearts .heart::after{ left:25%; top: -50%; }

    @keyframes floatUp{
        0%{ transform:rotate(45deg) translateY(0) scale(var(--scale,1)); opacity:0; }
        6%{ opacity:1; }
        50%{ opacity:0.95; transform:rotate(45deg) translateY(-40vh) scale(calc(var(--scale,1) * 1.05)); }
        100%{ transform:rotate(45deg) translateY(-120vh) scale(var(--scale,1)); opacity:0; }
    }

    .scene{width:360px;max-width:100%;position:relative;z-index:2;}
    /* Envelope */
    .envelope{
        position:relative;width:100%;height:220px;cursor:pointer;
        transform-origin:center top;transition:transform .6s ease;
        transform-style: preserve-3d;
        filter: drop-shadow(0 12px 30px rgba(255, 107, 129, 0.15));
    }
    .envelope .body{
        position:absolute;left:0;right:0;top:40px;height:160px;
        background:linear-gradient(135deg,#fff 0%, #fff8fb 50%, #fff5fa 100%);
        border-radius:6px;
        box-shadow:
            0 8px 18px rgba(255,107,129,.12),
            0 2px 8px rgba(255,107,129,.08),
            inset 0 1px 0 rgba(255,255,255,0.8);
        overflow:hidden;
        display:flex;align-items:center;justify-content:center;padding:16px;
    }
    .envelope .flap{
        position:absolute;left:0;right:0;top:0;height:90px;
        background:linear-gradient(135deg,#ffd7e0 0%, #ffd0f0 50%, #ffe0f5 100%);
        clip-path:polygon(0 0,50% 100%,100% 0);
        transform-origin:50% 0;
        transition:transform .6s cubic-bezier(.2,.9,.3,1);
        box-shadow:
            0 6px 14px rgba(255,107,129,.1),
            inset 0 -2px 6px rgba(255,107,129,.05);
    }
    .envelope.open .flap{transform:translateY(-70px) rotateX(180deg)}
    .letter{
        width:92%;height:86%;
        background:linear-gradient(135deg,var(--paper) 0%, #fff 50%, #fffef8 100%);
        border-radius:6px;padding:18px;
        box-shadow:
            inset 0 1px 0 rgba(255,255,255,.5),
            0 4px 12px rgba(255,107,129,.06);
        display:flex;flex-direction:column;align-items:flex-start;justify-content:center;gap:10px;text-align:left;cursor:pointer;
    }
    .letter h1{margin:0;font-size:20px;color:var(--accent);text-shadow: 0 2px 4px rgba(255,107,129,0.1)}
    .letter p{margin:0;color:#333;line-height:1.3}
    .hint{font-size:13px;color:#666;margin-top:8px}
    /* Cake */
    .cake-scene{display:none;flex-direction:column;align-items:center;gap:18px;padding-top:8px}
    .cake-scene.active{display:flex}
    .cake{
        width:260px;height:160px;position:relative;border-radius:12px;
        background:linear-gradient(135deg,var(--cake) 0%, #ffd58f 50%, #ffdf9f 100%);
        box-shadow:
            0 15px 35px rgba(255,107,129,.15),
            0 5px 15px rgba(255,107,129,.1),
            inset 0 2px 8px rgba(255,255,255,0.3);
        display:flex;align-items:flex-start;justify-content:center;padding-top:18px;
        overflow:visible;
    }
    .plate{
        position:absolute;bottom:-18px;width:320px;height:36px;
        background:linear-gradient(135deg,#fff 0%, #f5f5f5 50%, #eee 100%);
        border-radius:20px;
        box-shadow:
            0 8px 20px rgba(0,0,0,.08),
            inset 0 2px 4px rgba(255,255,255,0.5);
    }
    .candles{position:absolute;top:10px;display:flex;gap:18px}
    .candle{
        width:18px;height:40px;
        background:linear-gradient(135deg,#fff 0%, #f0f0f0 50%, #eee 100%);
        border-radius:4px;position:relative;
        box-shadow:
            inset 0 -6px 10px rgba(0,0,0,.06),
            0 4px 8px rgba(255,107,129,.1);
        display:flex;align-items:flex-start;justify-content:center;
    }
    .wick{position:absolute;top:-6px;width:2px;height:8px;background:#444;left:50%;transform:translateX(-50%);}
    .flame{
        position:absolute;top:-22px;left:50%;transform:translateX(-50%);width:14px;height:20px;border-radius:50% 50% 40% 40%/60% 60% 40% 40%;
        background:radial-gradient(circle at 30% 30%,#fff0 0 30%,#ffd86b 40%,#ff8b3d 60%,#ff4f00 85%);
        filter:drop-shadow(0 8px 12px rgba(255,120,30,.2));
        animation: flicker .18s infinite;
        opacity:1;
        transition:opacity .8s ease,transform .6s ease;
    }
    .flame.out{opacity:0;transform:translateY(-6px) scale(.7)}
    @keyframes flicker{
        0%{transform:translateX(-50%) translateY(0) scale(1)}
        50%{transform:translateX(-52%) translateY(-1px) scale(1.03)}
        100%{transform:translateX(-48%) translateY(0) scale(1)}
    }
    .message{font-size:16px;color:#333;text-align:center;text-shadow: 0 2px 4px rgba(255,107,129,0.05)}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:center}
    .btn{
        background:linear-gradient(135deg, var(--accent), #ff6b9d);
        color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;
        box-shadow:
            0 6px 18px rgba(255,107,129,.2),
            0 2px 6px rgba(255,107,129,.15);
        transition: all 0.3s ease;
    }
    .btn:hover {
        transform: translateY(-2px);
        box-shadow:
            0 8px 22px rgba(255,107,129,.25),
            0 4px 8px rgba(255,107,129,.2);
    }
    .small{
        font-size:13px;padding:6px 8px;border-radius:6px;
        background:linear-gradient(135deg, #fff, #fff5fa);
        border:1px solid rgba(255,107,129,0.2);
        color:#333;
        box-shadow: 0 4px 12px rgba(255,107,129,.1);
        transition: all 0.3s ease;
    }
    .small:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(255,107,129,.15);
    }
    .confetti{position:absolute;inset:0;pointer-events:none;z-index:4}
    
    /* Love message popup */
    .love-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0);
        background: linear-gradient(135deg, #fff 0%, #fff8fb 50%, #fff5fa 100%);
        padding: 40px 30px;
        border-radius: 20px;
        box-shadow: 
            0 20px 60px rgba(255, 107, 129, 0.3),
            0 10px 30px rgba(255, 107, 129, 0.2),
            inset 0 2px 8px rgba(255, 255, 255, 0.8);
        z-index: 1000;
        text-align: center;
        max-width: 90%;
        width: 400px;
        border: 2px solid rgba(255, 107, 129, 0.2);
        opacity: 0;
        transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    
    .love-popup.show {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
    }
    
    .love-popup-overlay {
        position: fixed;
        inset: 0;
        background: rgba(255, 192, 203, 0.3);
        backdrop-filter: blur(8px);
        z-index: 999;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.4s ease;
    }
    
    .love-popup-overlay.show {
        opacity: 1;
        pointer-events: all;
    }
    
    .love-message {
        font-size: 24px;
        font-weight: 600;
        color: var(--accent);
        margin: 0 0 20px 0;
        text-shadow: 0 2px 4px rgba(255, 107, 129, 0.1);
        line-height: 1.4;
        animation: heartbeat 1.5s ease-in-out infinite;
    }
    
    .popup-hearts {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
        font-size: 32px;
        animation: float 2s ease-in-out infinite;
    }
    
    .close-popup-btn {
        background: linear-gradient(135deg, var(--accent), #ff6b9d);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        font-size: 16px;
        cursor: pointer;
        box-shadow: 0 6px 20px rgba(255, 107, 129, 0.3);
        transition: all 0.3s ease;
    }
    
    .close-popup-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(255, 107, 129, 0.4);
    }
    
    @keyframes heartbeat {
        0%, 100% { transform: scale(1); }
        10%, 30% { transform: scale(1.05); }
        20%, 40% { transform: scale(1); }
    }
    
    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
    }
    
    /* cute heart badge near title */
    .love-badge{
        display:inline-flex;align-items:center;gap:8px;
        background:linear-gradient(135deg,#fff 0%, #fff8fb 50%, #fff6fb 100%);
        padding:6px 10px;border-radius:999px;
        border:1px solid rgba(255,90,140,.1);
        box-shadow:
            0 8px 20px rgba(255,90,140,.1),
            0 2px 8px rgba(255,90,140,.05);
    }
    .love-badge .mini-heart{
        width:18px;height:18px;transform:rotate(45deg);
        background:linear-gradient(135deg, var(--accent), #ff6b9d);
        border-radius:4px 4px 0 0;position:relative;
        box-shadow: 0 2px 6px rgba(255,107,129,.2);
    }
    .love-badge .mini-heart::before,
    .love-badge .mini-heart::after{content:"";position:absolute;width:50%;height:50%;background:inherit;border-radius:50%}
    .love-badge .mini-heart::before{left:0;top:-25%}
    .love-badge .mini-heart::after{left:25%;top:-50%}

    /* small responsive */
    @media(max-width:420px){
        .cake{width:220px;height:130px}
        .plate{width:280px}
    }
</style>
</head>
<body>
    <!-- 3D Floating Elements Background -->
    <div class="floating-3d">
        <!-- 3D Hearts -->
        <div class="float-element" style="left:10%;top:15%;--duration:18s;--delay:0s;--tx1:30px;--ty1:-40px;--tz1:25px;--tx2:-25px;--ty2:-80px;--tz2:-20px;--tx3:35px;--ty3:-120px;--tz3:30px">
            <div class="heart-3d" style="--size:45px;--color:#ff6b81;--color2:#ff9ac8"></div>
        </div>
        <div class="float-element" style="left:85%;top:20%;--duration:22s;--delay:3s;--tx1:-35px;--ty1:-50px;--tz1:30px;--tx2:30px;--ty2:-90px;--tz2:-25px;--tx3:-40px;--ty3:-130px;--tz3:35px">
            <div class="heart-3d" style="--size:38px;--color:#ffc3e1;--color2:#ffb3d9"></div>
        </div>
        <div class="float-element" style="left:50%;top:10%;--duration:20s;--delay:6s;--tx1:25px;--ty1:-45px;--tz1:20px;--tx2:-30px;--ty2:-85px;--tz2:-18px;--tx3:28px;--ty3:-125px;--tz3:22px">
            <div class="heart-3d" style="--size:35px;--color:#ff9ac8;--color2:#ffc3e1"></div>
        </div>

        <!-- Stars -->
        <div class="float-element" style="left:25%;top:25%;--duration:16s;--delay:2s;--tx1:40px;--ty1:-35px;--tz1:28px;--tx2:-35px;--ty2:-70px;--tz2:-22px;--tx3:38px;--ty3:-105px;--tz3:26px">
            <div class="star-3d" style="--size:32px"></div>
        </div>
        <div class="float-element" style="left:75%;top:35%;--duration:19s;--delay:5s;--tx1:-32px;--ty1:-42px;--tz1:24px;--tx2:28px;--ty2:-82px;--tz2:-19px;--tx3:-30px;--ty3:-115px;--tz3:22px">
            <div class="star-3d" style="--size:28px"></div>
        </div>

        <!-- Diamonds -->
        <div class="float-element" style="left:40%;top:30%;--duration:17s;--delay:1s;--tx1:22px;--ty1:-38px;--tz1:18px;--tx2:-28px;--ty2:-75px;--tz2:-15px;--tx3:25px;--ty3:-110px;--tz3:20px">
            <div class="diamond-3d" style="--size:30px"></div>
        </div>
        <div class="float-element" style="left:65%;top:18%;--duration:21s;--delay:4s;--tx1:-28px;--ty1:-48px;--tz1:22px;--tx2:32px;--ty2:-88px;--tz2:-17px;--tx3:-26px;--ty3:-122px;--tz3:24px">
            <div class="diamond-3d" style="--size:26px"></div>
        </div>

        <!-- Sparkles -->
        <div class="float-element" style="left:15%;top:40%;--duration:14s;--delay:0.5s;--tx1:18px;--ty1:-30px;--tz1:15px;--tx2:-20px;--ty2:-65px;--tz2:-12px;--tx3:22px;--ty3:-95px;--tz3:18px">
            <div class="sparkle-3d" style="--size:24px"></div>
        </div>
        <div class="float-element" style="left:80%;top:50%;--duration:15s;--delay:2.5s;--tx1:-24px;--ty1:-36px;--tz1:20px;--tx2:26px;--ty2:-72px;--tz2:-16px;--tx3:-22px;--ty3:-108px;--tz3:19px">
            <div class="sparkle-3d" style="--size:22px"></div>
        </div>
        <div class="float-element" style="left:55%;top:45%;--duration:16s;--delay:4.5s;--tx1:20px;--ty1:-32px;--tz1:16px;--tx2:-22px;--ty2:-68px;--tz2:-14px;--tx3:24px;--ty3:-100px;--tz3:17px">
            <div class="sparkle-3d" style="--size:20px"></div>
        </div>
    </div>

    <!-- decorative floating hearts background -->
    <div class="bg-hearts" aria-hidden="true">
        <div class="heart" style="left:8%; --size:28px; --duration:12s; --delay:0s; --scale:1; --color:var(--heart1)"></div>
        <div class="heart" style="left:18%; --size:20px; --duration:9s; --delay:2s; --scale:0.9; --color:var(--heart3)"></div>
        <div class="heart" style="left:32%; --size:24px; --duration:11s; --delay:1s; --scale:1.05; --color:var(--heart2)"></div>
        <div class="heart" style="left:44%; --size:34px; --duration:14s; --delay:3s; --scale:1.1; --color:var(--heart4)"></div>
        <div class="heart" style="left:56%; --size:22px; --duration:10s; --delay:4s; --scale:0.95; --color:var(--heart5)"></div>
        <div class="heart" style="left:68%; --size:30px; --duration:13s; --delay:1.5s; --scale:1; --color:var(--heart1)"></div>
        <div class="heart" style="left:78%; --size:18px; --duration:8s; --delay:0.5s; --scale:0.85; --color:var(--heart3)"></div>
        <div class="heart" style="left:86%; --size:26px; --duration:12s; --delay:2.5s; --scale:1.02; --color:var(--heart2)"></div>
        <div class="heart" style="left:52%; bottom:-120px; --size:40px; --duration:16s; --delay:6s; --scale:1.15; --color:rgba(255,110,140,0.9)"></div>
        <div class="heart" style="left:26%; bottom:-100px; --size:16px; --duration:9.5s; --delay:3.2s; --scale:0.8; --color:var(--heart5)"></div>
        <div class="heart" style="left:12%; bottom:-60px; --size:20px; --duration:10s; --delay:1.2s; --scale:0.95; --color:var(--heart4)"></div>
        <div class="heart" style="left:90%; bottom:-60px; --size:20px; --duration:10s; --delay:5.2s; --scale:0.95; --color:var(--heart4)"></div>
    </div>

    <div class="scene">
        <div style="display:flex;justify-content:center;margin-bottom:12px;">
            <div class="love-badge" aria-hidden="true">
                <div class="mini-heart"></div>
                <div style="font-size:14px;color:#aa2750">With all my heart</div>
            </div>
        </div>

        <div class="envelope" id="envelope" title="Open the envelope">
            <div class="flap"></div>
            <div class="body">
                <div class="letter" id="letter" title="Open message">
                    <h1>Happy Birthday, My Love!</h1>
                    <p>To my dearest Vaishuuu - wishing you a day as sweet as you are. Click me again for a surprise!</p>
                    <div class="hint">Click the letter to reveal your cake 🎂</div>
                </div>
            </div>
        </div>

        <div class="cake-scene" id="cakeScene" aria-hidden="true">
            <div class="message">Make a wish and blow to blow out the candles!</div>
            <div style="position:relative;">
                <div class="cake" id="cake">
                    <div class="candles" id="candles" style="left:50%;transform:translateX(-50%);">
                        <!-- 5 candles -->
                        <div class="candle"><div class="wick"></div><div class="flame"></div></div>
                        <div class="candle"><div class="wick"></div><div class="flame"></div></div>
                        <div class="candle"><div class="wick"></div><div class="flame"></div></div>
                        <div class="candle"><div class="wick"></div><div class="flame"></div></div>
                        <div class="candle"><div class="wick"></div><div class="flame"></div></div>
                    </div>
                    <div class="plate"></div>
                </div>
                <canvas class="confetti" id="confetti"></canvas>
            </div>
            <div class="controls">
                <button class="btn small" id="startBtn">Microphone allow kro & blow uff uff</button>
                <button class="btn small" id="resetBtn">Reset</button>
                <div id="status" style="color:#666;font-size:13px;margin-left:8px">Microphone: off</div>
            </div>
        </div>
    </div>

    <!-- Love Message Popup -->
    <div class="love-popup-overlay" id="lovePopupOverlay"></div>
    <div class="love-popup" id="lovePopup">
        <div class="popup-hearts">💕💕💕</div>
        <p class="love-message">I Love You so muchhh<br>vaishuuuuuu babyyyyy 💕💕😘</p>
        <button class="close-popup-btn" id="closePopupBtn">Close 💖</button>
    </div>

<script>
/* Interaction:
 - Click envelope to open flap and reveal letter.
 - Click letter to show cake & start microphone detection (via button).
 - Detect blow via microphone volume; when detected => extinguish flames.
*/

const envelope = document.getElementById('envelope');
const letter = document.getElementById('letter');
const cakeScene = document.getElementById('cakeScene');
const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');
const status = document.getElementById('status');
const flames = document.querySelectorAll('.flame');
const confettiCanvas = document.getElementById('confetti');
const lovePopup = document.getElementById('lovePopup');
const lovePopupOverlay = document.getElementById('lovePopupOverlay');
const closePopupBtn = document.getElementById('closePopupBtn');

let stream = null, audioCtx = null, analyser = null, rafId = null;
let blowingDetected = false;

// open envelope flap on first click
envelope.addEventListener('click', () => {
    envelope.classList.toggle('open');
});

// click letter => show cake
letter.addEventListener('click', () => {
    envelope.style.display = 'none';
    cakeScene.classList.add('active');
    cakeScene.setAttribute('aria-hidden','false');
});

// audio helpers
function startMic(){
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        alert('Microphone access not supported in this browser.');
        return;
    }
    
    // Better mobile microphone constraints
    const constraints = {
        audio: {
            echoCancellation: false,
            noiseSuppression: false,
            autoGainControl: false,
            googEchoCancellation: false,
            googAutoGainControl: false,
            googNoiseSuppression: false,
            googHighpassFilter: false
        }
    };
    
    navigator.mediaDevices.getUserMedia(constraints).then(s => {
        stream = s;
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioCtx.createMediaStreamSource(stream);
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 2048; // Increased for better mobile detection
        analyser.smoothingTimeConstant = 0.3; // Less smoothing for faster response
        source.connect(analyser);
        status.textContent = 'Microphone: listening... Blow now!';
        startBtn.textContent = 'Listening... 💨';
        startBtn.disabled = true;
        monitorVolume();
    }).catch(err => {
        console.error(err);
        alert('Microphone permission denied. Please allow microphone access and try again.');
    });
}

function stopMic(){
    if (rafId) cancelAnimationFrame(rafId);
    if (analyser) try{ analyser.disconnect(); }catch(e){}
    if (audioCtx) try{audioCtx.close();}catch(e){}
    if (stream){
        stream.getTracks().forEach(t=>t.stop());
        stream = null;
    }
    startBtn.disabled = false;
    startBtn.textContent = 'Microphone allow kro & blow uff uff';
    if (!blowingDetected) {
        status.textContent = 'Microphone: off';
    }
    sampleCount = 0; // Reset calibration
}

// Enhanced volume detection with better mobile sensitivity
let baseline = 0.01;
let lastBlowTime = 0;
let sampleCount = 0;

function monitorVolume(){
    const bufferLength = analyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);
    const timeData = new Float32Array(analyser.fftSize);
    const now = performance.now();
    
    analyser.getByteFrequencyData(dataArray);
    analyser.getFloatTimeDomainData(timeData);

    // Calculate RMS from time domain
    let sum = 0;
    for (let i = 0; i < timeData.length; i++){
        sum += timeData[i] * timeData[i];
    }
    let rms = Math.sqrt(sum / timeData.length);

    // Calculate average frequency energy (good for blow detection)
    let freqSum = 0;
    for (let i = 0; i < bufferLength; i++){
        freqSum += dataArray[i];
    }
    let avgFreq = freqSum / bufferLength;

    // Update baseline gradually
    sampleCount++;
    if (sampleCount < 30) {
        // Initial calibration
        baseline = Math.max(baseline, rms);
    } else {
        baseline = baseline * 0.99 + rms * 0.01;
    }

    // Mobile-friendly thresholds (more sensitive)
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    const rmsThreshold = isMobile ? 0.05 : 0.12; // Lower threshold for mobile
    const baselineMultiplier = isMobile ? 2.5 : 4;
    
    // Detect blow: spike in RMS or frequency energy
    const blowDetected = (rms > Math.max(rmsThreshold, baseline * baselineMultiplier)) || 
                        (avgFreq > 40 && rms > 0.03);
    
    if (!blowingDetected && blowDetected) {
        // Debounce to prevent multiple triggers
        if (now - lastBlowTime > 600) {
            lastBlowTime = now;
            onBlowDetected();
            return; // Stop monitoring after detection
        }
    }
    
    // Visual feedback for debugging (optional)
    if (sampleCount % 10 === 0) {
        const level = Math.min(100, Math.floor(rms * 500));
        status.textContent = `Listening... Volume: ${'▮'.repeat(Math.floor(level/10))} ${Math.floor(level)}%`;
    }
    
    rafId = requestAnimationFrame(monitorVolume);
}

function onBlowDetected(){
    blowingDetected = true;
    status.textContent = 'Blow detected! Candles out 🎉';
    // extinguish flames
    flames.forEach(f => f.classList.add('out'));
    stopMic();
    burstConfetti();
    
    // Show love message popup after 1.5 seconds
    setTimeout(() => {
        showLovePopup();
    }, 1500);
}

// Show love message popup
function showLovePopup() {
    lovePopupOverlay.classList.add('show');
    lovePopup.classList.add('show');
}

// Close popup
function closeLovePopup() {
    lovePopupOverlay.classList.remove('show');
    lovePopup.classList.remove('show');
}

// Event listeners for popup
closePopupBtn.addEventListener('click', closeLovePopup);
lovePopupOverlay.addEventListener('click', closeLovePopup);

// confetti simple particle system
function burstConfetti(){
    const ctx = confettiCanvas.getContext('2d');
    function resize(){ confettiCanvas.width = confettiCanvas.clientWidth = confettiCanvas.offsetWidth; confettiCanvas.height = confettiCanvas.clientHeight = confettiCanvas.offsetHeight; }
    confettiCanvas.style.width = confettiCanvas.style.height = confettiCanvas.parentElement.offsetHeight + 'px';
    resize();
    const w = confettiCanvas.width, h = confettiCanvas.height;
    const particles = [];
    for (let i=0;i<80;i++){
        particles.push({
            x: w/2 + (Math.random()-0.5)*200,
            y: h/2 + 20,
            vx: (Math.random()-0.5)*8,
            vy: - (4 + Math.random()*8),
            r: 6 + Math.random()*6,
            color: ['#ff4f00','#ffd86b','#ff6b81','#ff9ac8','#7ed0ff'][Math.floor(Math.random()*5)],
            rot: Math.random()*360,
            vr: (Math.random()-0.5)*10,
            life: 0
        });
    }
    let t = 0;
    const ttl = 160;
    function frame(){
        t++;
        ctx.clearRect(0,0,w,h);
        particles.forEach(p=>{
            p.vy += 0.24; p.x += p.vx; p.y += p.vy; p.rot += p.vr; p.life++;
            ctx.save();
            ctx.translate(p.x,p.y); ctx.rotate(p.rot*Math.PI/180);
            ctx.fillStyle = p.color;
            ctx.fillRect(-p.r/2, -p.r/2, p.r, p.r*0.6);
            ctx.restore();
        });
        if (t < ttl) requestAnimationFrame(frame);
        else ctx.clearRect(0,0,w,h);
    }
    frame();
}

startBtn.addEventListener('click', () => {
    if (!stream) startMic();
});
resetBtn.addEventListener('click', () => {
    // reset UI
    blowingDetected = false;
    envelope.style.display = '';
    envelope.classList.remove('open');
    cakeScene.classList.remove('active');
    cakeScene.setAttribute('aria-hidden','true');
    flames.forEach(f => f.classList.remove('out'));
    stopMic();
    status.textContent = 'Microphone: off';
    
    // Close popup if open
    closeLovePopup();
});

/* Accessibility note: Microphone requires secure origin (https) in many browsers.
     Test locally via localhost or a deployed HTTPS site. */
</script>
</body>
</html>